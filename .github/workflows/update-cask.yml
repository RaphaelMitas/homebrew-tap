name: Update Cask

on:
  workflow_dispatch:
    inputs:
      cask_name:
        description: 'Cask name (e.g., example-app)'
        required: true
        type: string
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      source_repo:
        description: 'Source repository (e.g., raphaelmitas/ExampleApp)'
        required: true
        type: string

jobs:
  update-cask:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Extract version and app name from tag
        id: info
        run: |
          TAG="${{ inputs.release_tag }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Extract app name from repo (e.g., raphaelmitas/ExampleApp -> ExampleApp)
          APP_NAME="${{ inputs.source_repo }}"
          APP_NAME="${APP_NAME##*/}"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Download release zip
        run: |
          DOWNLOAD_URL="https://github.com/${{ inputs.source_repo }}/releases/download/${{ inputs.release_tag }}/${{ steps.info.outputs.app_name }}-${{ steps.info.outputs.version }}.zip"
          echo "Downloading from: $DOWNLOAD_URL"
          curl -fSL -o app.zip "$DOWNLOAD_URL"

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 app.zip | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Update cask file
        run: |
          CASK_FILE="Casks/${{ inputs.cask_name }}.rb"

          if [ ! -f "$CASK_FILE" ]; then
            echo "Error: Cask file not found: $CASK_FILE"
            exit 1
          fi

          # Update version
          sed -i '' 's/version "[^"]*"/version "${{ steps.info.outputs.version }}"/' "$CASK_FILE"

          # Update sha256
          sed -i '' 's/sha256 "[^"]*"/sha256 "${{ steps.sha256.outputs.sha256 }}"/' "$CASK_FILE"

          # Update source repo in URL if it changed
          sed -i '' "s|github.com/[^/]*/[^/]*/releases|github.com/${{ inputs.source_repo }}/releases|g" "$CASK_FILE"

          echo "Updated cask:"
          cat "$CASK_FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Casks/${{ inputs.cask_name }}.rb"
          git commit -m "Update ${{ inputs.cask_name }} to ${{ inputs.release_tag }}"
          git push
