name: Update Formula

on:
  workflow_dispatch:
    inputs:
      formula_name:
        description: 'Formula name (e.g., example-cli)'
        required: true
        type: string
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      source_repo:
        description: 'Source repository (e.g., raphaelmitas/example-cli)'
        required: true
        type: string

jobs:
  update-formula:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ inputs.release_tag }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release binary
        run: |
          DOWNLOAD_URL="https://github.com/${{ inputs.source_repo }}/releases/download/${{ inputs.release_tag }}/${{ inputs.formula_name }}-${{ steps.version.outputs.version }}-arm64.tar.gz"
          echo "Downloading from: $DOWNLOAD_URL"
          curl -fSL -o binary.tar.gz "$DOWNLOAD_URL"

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 binary.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Update formula file
        run: |
          FORMULA_FILE="Formula/${{ inputs.formula_name }}.rb"

          if [ ! -f "$FORMULA_FILE" ]; then
            echo "Error: Formula file not found: $FORMULA_FILE"
            exit 1
          fi

          # Update version
          sed -i '' 's/version "[^"]*"/version "${{ steps.version.outputs.version }}"/' "$FORMULA_FILE"

          # Update sha256
          sed -i '' 's/sha256 "[^"]*"/sha256 "${{ steps.sha256.outputs.sha256 }}"/' "$FORMULA_FILE"

          # Update source repo in URL if it changed
          sed -i '' "s|github.com/[^/]*/[^/]*/releases|github.com/${{ inputs.source_repo }}/releases|g" "$FORMULA_FILE"

          echo "Updated formula:"
          cat "$FORMULA_FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${{ inputs.formula_name }}.rb"
          git commit -m "Update ${{ inputs.formula_name }} to ${{ inputs.release_tag }}"
          git push
